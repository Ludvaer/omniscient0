<%
translation_set = pick_word_in_set.translation_set
translations = translation_set&.translations
correct = translations&.find{|t| t.id == pick_word_in_set.correct_id}
optionboard_id = if correct.nil? then 'optionboard_new' else "optionboard_#{pick_word_in_set.id}" end
div_id = if correct.nil? then 'pick_word_in_set_new_div' else "pick_word_in_set_#{pick_word_in_set.id}_div" end
form_id = if correct.nil? then 'test_pick_new_form' else "test_pick_#{pick_word_in_set.id}_form" end
picked_id = if correct.nil? then 'test_pick_new_input' else "test_pick_#{pick_word_in_set.id}_input" end
%>
<div class="pick_word_in_set" id="<%= div_id %>">
<%# if correct %>
  <div class="optionboard" id="<%= optionboard_id %>">
    <svg class="fit-text source-word" xmlns="http://www.w3.org/2000/svg">
      <text dominant-baseline="middle" text-anchor="middle">
        <%= correct&.word&.spelling %>
      </text>
    </svg>
    <p class="comment-word">Kana Transcription</p>
    <%# translations&.each do |translation| %>
    <% (1..9).each do |i| %>
      <%  translation =  translations ? translations[i] : false %>
      <button type="button">
        <div class="option-wrap">
            <span class="option-marker"><%=i%>:</span>
            <span class="option-text"><%=translation ? translation.translation : "" %></span>
        </div>
      </button>
    <% end %>
    <button type="button" class="btn-dunno"  >
      <div class="option-wrap">
        <span class="option-marker">0:</span>
        <span class="option-text"> Don't know </span>
      </div>
    </button>
    <button type="button" onclick="moveNewPick(pick_model_<%= pick_word_in_set.id %>)">
      <div class="option-wrap">
        <span class="option-marker">enter:</span>
        <span class="option-text"> Next </span>
      </div>
    </button>
  </div>
<%# end %>
</div>

<script>
  var declared_pick_model_inits;
  try {
    pick_model_inits = pick_model_inits? pick_model_inits : [];
    declared_pick_model_inits = true;
  } catch(e) {
    declared_pick_model_inits = false;
  }
  pick_model_inits = declared_pick_model_inits ? pick_model_inits : [];

  var declared_loadedPickWordInSet<%= pick_word_in_set.id %>;
  try {
    isLoadedPickWordInSet<%= pick_word_in_set.id %>;
    declared_loadedPickWordInSet<%= pick_word_in_set.id %> = true;
  } catch(e) {
    declared_loadedPickWordInSet<%= pick_word_in_set.id %> = false;
  }
  isLoadedPickWordInSet<%= pick_word_in_set.id %> = declared_loadedPickWordInSet<%= pick_word_in_set.id %> ? isLoadedPickWordInSet<%= pick_word_in_set.id %> : false;

  function pick_model_<%= pick_word_in_set.id %>_load() {
    if(isLoadedPickWordInSet<%= pick_word_in_set.id %>) {
      console.log(`=== already loaded`);
      var pick_div = document.getElementById("<%= div_id %>");
      if(pick_div == null){
        console.log(`=== pick_div null`);
        //document.removeEventListener('turbolinks:load', pick_model_<%= pick_word_in_set.id %>_load);
        return;
      }
      pick_model_<%= pick_word_in_set.id %> = form_form_model_from(pick_div);
      fill_form(pick_model_<%= pick_word_in_set.id %>);
      return;
    }
    dunnoText = '<%=t("I don't know").html_safe%>';
    nextText = '<%=t("Next").html_safe%>';
    var pick_div = document.getElementById("<%= div_id %>");
    if(pick_div == null){
      console.log(`=== pick_div null`);
      //document.removeEventListener('turbolinks:load', pick_model_<%= pick_word_in_set.id %>_load);
      return;
    }
    var declaredFormFormFrom;
    try {
      form_form_model_from;
      declaredFormFormFrom = true;
    } catch(e) {
      declaredFormFormFrom = false;
    }
    if(!declaredFormFormFrom || form_form_model_from == null) {
      console.log(`=== form_form_model_from null`);
      return;
    }
    console.log(`=== loading`);
    isLoadedPickWordInSet<%= pick_word_in_set.id %> = true;
    pick_model_<%= pick_word_in_set.id %> = form_form_model_from(pick_div);
    data_preload_url = "<%= data_preload_url %>";
    pick_word_in_sets_url = "<%= pick_word_in_sets_url %>";
    preload_queue_target_size = 10;
    <% ids = locals[:ids]%>
    <% ids = if defined?(ids) && (!ids.nil?) then ids else [] end %>
    <% ids = if ids.empty? && !pick_word_in_set.id.nil? then [pick_word_in_set.id] else ids end %>
    <% ids = if ids.include?(pick_word_in_set.id) then ids else ids + [pick_word_in_set.id] end %>
    <% preloadedData = DataPreloadService.fetch_data({"PickWordInSet" => ids}, recursive: true) %>
    receiveData(<%= preloadedData.to_json.html_safe %>, ()=> {
      // preloadData({"PickWordInSet":[<%=pick_word_in_set.id %>]}, ()=> { // this shoud send request instead of prerender in place of receiveData
      <% if pick_word_in_set.id.nil? %>
        fill_form(pick_model_<%= pick_word_in_set.id %>)
      <% else %>
        moveNewPick(pick_model_<%= pick_word_in_set.id %>, <%= pick_word_in_set.id %>)
      <% end %>
    //pick_word_in_set_<%=pick_word_in_set.id %> = recordManager.objects['PickWordInSet'][<%= pick_word_in_set.id  %>];
    //pick_model_<%= pick_word_in_set.id %>.data = pick_word_in_set_<%=pick_word_in_set.id %>;
    //fill_form(pick_model_<%= pick_word_in_set.id %>)
      <% unless locals[:activated] %>
         pick_model_<%= pick_word_in_set.id %>.nextButton.hidden =true;
      <%end%>
    });
  };
  pick_model_inits.push( pick_model_<%= pick_word_in_set.id %>_load);
  document.addEventListener('turbolinks:load', pick_model_<%= pick_word_in_set.id %>_load);
  //document.onload = pick_model_<%= pick_word_in_set.id %>_load;
</script>
